<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 13 Dealing with unbalanced data | A Machine Learning Compilation</title>
<meta name="author" content="Several authors. Compiled by Alfonso R. Reyes">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.2.9000/tabs.js"></script><script src="libs/bs3compat-0.2.2.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">A Machine Learning Compilation</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Preface</a></li>
<li class="book-part">The Basics of Machine Learning</li>
<li><a class="" href="introduction-to-pca.html"><span class="header-section-number">2</span> Introduction to PCA</a></li>
<li><a class="" href="comparison-of-two-pca-packages.html"><span class="header-section-number">3</span> Comparison of two PCA packages</a></li>
<li><a class="" href="detailed-study-of-principal-component-analysis.html"><span class="header-section-number">4</span> Detailed study of Principal Component Analysis</a></li>
<li><a class="" href="detection-of-diabetes-using-logistic-regression.html"><span class="header-section-number">5</span> Detection of diabetes using Logistic Regression</a></li>
<li><a class="" href="sensitivity-analysis-for-a-neural-network.html"><span class="header-section-number">6</span> Sensitivity analysis for a neural network</a></li>
<li><a class="" href="data-visualization-for-ml-models.html"><span class="header-section-number">7</span> Data Visualization for ML models</a></li>
<li class="book-part">Feature Engineering</li>
<li><a class="" href="ten-methods-to-assess-variable-importance.html"><span class="header-section-number">8</span> Ten methods to assess Variable Importance</a></li>
<li><a class="" href="employee-attrition-using-feature-importance.html"><span class="header-section-number">9</span> Employee Attrition using Feature Importance</a></li>
<li class="book-part">Classification</li>
<li><a class="" href="a-gentle-introduction-to-support-vector-machines.html"><span class="header-section-number">10</span> A gentle introduction to Support Vector Machines</a></li>
<li><a class="" href="broad-view-of-svm.html"><span class="header-section-number">11</span> Broad view of SVM</a></li>
<li><a class="" href="feature-selection-to-enhance-cancer-detection.html"><span class="header-section-number">12</span> Feature Selection to enhance cancer detection</a></li>
<li><a class="active" href="dealing-with-unbalanced-data.html"><span class="header-section-number">13</span> Dealing with unbalanced data</a></li>
<li><a class="" href="imputting-missing-values-with-random-forest.html"><span class="header-section-number">14</span> Imputting missing values with Random Forest</a></li>
<li><a class="" href="tuning-of-support-vector-machine-prediction.html"><span class="header-section-number">15</span> Tuning of Support Vector Machine prediction</a></li>
<li class="book-part">Classification</li>
<li><a class="" href="introduction-to-algorithms-for-classification.html"><span class="header-section-number">16</span> Introduction to algorithms for Classification</a></li>
<li><a class="" href="comparing-classification-algorithms.html"><span class="header-section-number">17</span> Comparing Classification algorithms</a></li>
<li><a class="" href="who-buys-social-network-ads.html"><span class="header-section-number">18</span> Who buys Social Network ads</a></li>
<li><a class="" href="predicting-ozone-levels.html"><span class="header-section-number">19</span> Predicting Ozone levels</a></li>
<li><a class="" href="building-a-naive-bayes-classifier.html"><span class="header-section-number">20</span> Building a Naive Bayes Classifier</a></li>
<li><a class="" href="linear-and-non-linear-algorithms-for-classification.html"><span class="header-section-number">21</span> Linear and Non-Linear Algorithms for Classification</a></li>
<li><a class="" href="detect-mines-vs-rocks-with-random-forest.html"><span class="header-section-number">22</span> Detect mines vs rocks with Random Forest</a></li>
<li><a class="" href="predicting-the-type-of-glass.html"><span class="header-section-number">23</span> Predicting the type of glass</a></li>
<li><a class="" href="naive-bayes-for-sms-spam.html"><span class="header-section-number">24</span> Naive Bayes for SMS spam</a></li>
<li><a class="" href="vehicles-classiification-with-decision-trees.html"><span class="header-section-number">25</span> Vehicles classiification with Decision Trees</a></li>
<li><a class="" href="applying-naive-bayes-on-the-titanic-case.html"><span class="header-section-number">26</span> Applying Naive-Bayes on the Titanic case</a></li>
<li><a class="" href="classification-on-bad-loans.html"><span class="header-section-number">27</span> Classification on bad loans</a></li>
<li><a class="" href="predicting-flu-outcome-comparing-eight-classification-algorithms.html"><span class="header-section-number">28</span> Predicting Flu outcome comparing eight classification algorithms</a></li>
<li><a class="" href="a-detailed-study-of-bike-sharing-demand.html"><span class="header-section-number">29</span> A detailed study of bike sharing demand</a></li>
<li><a class="" href="prediction-of-arrhythmia-with-deep-neural-nets.html"><span class="header-section-number">30</span> Prediction of arrhythmia with deep neural nets</a></li>
<li class="book-part">Linear Regression</li>
<li><a class="" href="linear-regression-with-islr.html"><span class="header-section-number">31</span> Linear Regression with ISLR</a></li>
<li><a class="" href="evaluation-of-three-linear-regression-models.html"><span class="header-section-number">32</span> Evaluation of three linear regression models</a></li>
<li><a class="" href="comparison-of-six-linear-regression-algorithms.html"><span class="header-section-number">33</span> Comparison of six Linear Regression algorithms</a></li>
<li><a class="" href="comparing-regression-models.html"><span class="header-section-number">34</span> Comparing regression models</a></li>
<li><a class="" href="finding-the-factors-of-happiness.html"><span class="header-section-number">35</span> Finding the factors of happiness</a></li>
<li><a class="" href="regression-with-a-neural-network.html"><span class="header-section-number">36</span> Regression with a neural network</a></li>
<li><a class="" href="comparing-multiple-regression-vs-a-neural-network.html"><span class="header-section-number">37</span> Comparing Multiple Regression vs a Neural Network</a></li>
<li><a class="" href="temperature-modeling-using-nested-dataframes.html"><span class="header-section-number">38</span> Temperature modeling using nested dataframes</a></li>
<li class="book-part">Neural Networks</li>
<li><a class="" href="credit-scoring-with-neuralnet.html"><span class="header-section-number">39</span> Credit Scoring with neuralnet</a></li>
<li><a class="" href="wine-classification-with-neuralnet.html"><span class="header-section-number">40</span> Wine classification with neuralnet</a></li>
<li><a class="" href="predicting-the-rating-of-cereals.html"><span class="header-section-number">41</span> Predicting the rating of cereals</a></li>
<li><a class="" href="fitting-a-linear-model-with-neural-networks.html"><span class="header-section-number">42</span> Fitting a linear model with neural networks</a></li>
<li><a class="" href="visualization-of-neural-networks.html"><span class="header-section-number">43</span> Visualization of neural networks</a></li>
<li><a class="" href="build-a-fully-connected-r-neural-network-from-scratch.html"><span class="header-section-number">44</span> Build a fully connected R neural network from scratch</a></li>
<li><a class="" href="tuning-hyperparameters-in-a-neural-network.html"><span class="header-section-number">45</span> Tuning Hyperparameters in a Neural Network</a></li>
<li><a class="" href="deep-learning-tips-for-classification-and-regression.html"><span class="header-section-number">46</span> Deep Learning tips for Classification and Regression</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="what-is-dot-hat-in-a-regression-output.html"><span class="header-section-number">A</span> What is dot hat in a regression output</a></li>
<li><a class="" href="q-q-normal-to-compare-data-to-distributions.html"><span class="header-section-number">B</span> Q-Q normal to compare data to distributions</a></li>
<li><a class="" href="qq-and-pp-plots.html"><span class="header-section-number">C</span> QQ and PP Plots</a></li>
<li><a class="" href="visualizing-residuals.html"><span class="header-section-number">D</span> Visualizing residuals</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/f0nzie/machine_learning_compilation">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="dealing-with-unbalanced-data" class="section level1">
<h1>
<span class="header-section-number">13</span> Dealing with unbalanced data<a class="anchor" aria-label="anchor" href="#dealing-with-unbalanced-data"><i class="fas fa-link"></i></a>
</h1>
<div id="breast-cancer-dataset" class="section level2">
<h2>
<span class="header-section-number">13.1</span> Breast cancer dataset<a class="anchor" aria-label="anchor" href="#breast-cancer-dataset"><i class="fas fa-link"></i></a>
</h2>
</div>
<div id="introduction-6" class="section level2">
<h2>
<span class="header-section-number">13.2</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-6"><i class="fas fa-link"></i></a>
</h2>
<p>Source: <a href="https://shiring.github.io/machine_learning/2017/04/02/unbalanced" class="uri">https://shiring.github.io/machine_learning/2017/04/02/unbalanced</a></p>
<div class="sourceCode" id="cb335"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: lattice</span>
<span class="co">#&gt; Loading required package: ggplot2</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stefvanbuuren/mice">mice</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'mice'</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     cbind, rbind</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
<p>In my last post, where I shared the code that I used to produce an example analysis to go along with my webinar on building meaningful models for disease prediction, I mentioned that it is advised to consider over- or under-sampling when you have unbalanced data sets. Because my focus in this webinar was on evaluating model performance, I did not want to add an additional layer of complexity and therefore did not further discuss how to specifically deal with unbalanced data.</p>
<p>But because I had gotten a few questions regarding this, I thought it would be worthwhile to explain over- and under-sampling techniques in more detail and show how you can very easily implement them with <code>caret</code>.</p>
</div>
<div id="read-and-process-the-data-1" class="section level2">
<h2>
<span class="header-section-number">13.3</span> Read and process the data<a class="anchor" aria-label="anchor" href="#read-and-process-the-data-1"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb336"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bc_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">data_raw_dir</span>, <span class="st">"breast-cancer-wisconsin.data"</span><span class="op">)</span>, 
                      header <span class="op">=</span> <span class="cn">FALSE</span>, sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample_code_number"</span>, <span class="st">"clump_thickness"</span>, 
                       <span class="st">"uniformity_of_cell_size"</span>, <span class="st">"uniformity_of_cell_shape"</span>,
                       <span class="st">"marginal_adhesion"</span>, <span class="st">"single_epithelial_cell_size"</span>, 
                       <span class="st">"bare_nuclei"</span>, <span class="st">"bland_chromatin"</span>, <span class="st">"normal_nucleoli"</span>, 
                       <span class="st">"mitosis"</span>, <span class="st">"classes"</span><span class="op">)</span>

<span class="va">bc_data</span><span class="op">$</span><span class="va">classes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">$</span><span class="va">classes</span> <span class="op">==</span> <span class="st">"2"</span>, <span class="st">"benign"</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">$</span><span class="va">classes</span> <span class="op">==</span> <span class="st">"4"</span>, <span class="st">"malignant"</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>

<span class="va">bc_data</span><span class="op">[</span><span class="va">bc_data</span> <span class="op">==</span> <span class="st">"?"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>

<span class="co"># how many NAs are in the data</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 16</span></code></pre></div>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># impute missing data</span>

<span class="co"># skip columns: sample_code_number and classes</span>
<span class="va">bc_data</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># impute but stay mute</span>
<span class="va">dataset_impute</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mice/man/mice.html">mice</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,  print <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># bind "classes" with the rest. skip "sample_code_number"</span>
<span class="va">bc_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mice/man/cbind.html">cbind</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">[</span>, <span class="fl">11</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, 
                 <span class="fu">mice</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mice/man/complete.mids.html">complete</a></span><span class="op">(</span><span class="va">dataset_impute</span>, action <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="va">bc_data</span><span class="op">$</span><span class="va">classes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span></code></pre></div>
<div id="unbalanced-data" class="section level3">
<h3>
<span class="header-section-number">13.3.1</span> Unbalanced data<a class="anchor" aria-label="anchor" href="#unbalanced-data"><i class="fas fa-link"></i></a>
</h3>
<p>In this context, unbalanced data refers to classification problems where we have unequal instances for different classes. Having unbalanced data is actually very common in general, but it is especially prevalent when working with disease data where we usually have more healthy control samples than disease cases. Even more extreme unbalance is seen with fraud detection, where e.g. most credit card uses are okay and only very few will be fraudulent. In the example I used for my webinar, a <em>breast cancer</em> dataset, we had about twice as many benign than malignant samples.</p>
<div class="sourceCode" id="cb338"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># how many benign and malignant cases are there?</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span>
<span class="co">#&gt;    benign malignant </span>
<span class="co">#&gt;       458       241</span></code></pre></div>
<div id="why-is-unbalanced-data-a-problem-in-machine-learning" class="section level4">
<h4>
<span class="header-section-number">13.3.1.1</span> Why is unbalanced data a problem in machine learning?<a class="anchor" aria-label="anchor" href="#why-is-unbalanced-data-a-problem-in-machine-learning"><i class="fas fa-link"></i></a>
</h4>
<p>Most machine learning classification algorithms are sensitive to unbalance in the predictor classes. Let’s consider an even more extreme example than our breast cancer dataset: assume we had 10 malignant vs 90 benign samples. A machine learning model that has been trained and tested on such a dataset could now predict “benign” for all samples and still gain a very high accuracy. An unbalanced dataset will bias the prediction model towards the more common class!</p>
</div>
<div id="how-to-balance-data-for-modeling" class="section level4">
<h4>
<span class="header-section-number">13.3.1.2</span> How to balance data for modeling<a class="anchor" aria-label="anchor" href="#how-to-balance-data-for-modeling"><i class="fas fa-link"></i></a>
</h4>
<p>The basic theoretical concepts behind over- and under-sampling are very simple:</p>
<p>With under-sampling, we randomly select a subset of samples from the class with more instances to match the number of samples coming from each class. In our example, we would randomly pick 241 out of the 458 benign cases. The main disadvantage of under-sampling is that we lose potentially relevant information from the left-out samples.</p>
<p>With oversampling, we randomly duplicate samples from the class with fewer instances or we generate additional instances based on the data that we have, so as to match the number of samples in each class. While we avoid losing information with this approach, we also run the risk of overfitting our model as we are more likely to get the same samples in the training and in the test data, i.e. the test data is no longer independent from training data. This would lead to an overestimation of our model’s performance and generalizability.</p>
<p>In reality though, we should not simply perform over- or under-sampling on our training data and then run the model. We need to account for cross-validation and perform over- or under-sampling on each fold independently to get an honest estimate of model performance!</p>
</div>
<div id="modeling-the-original-unbalanced-data" class="section level4">
<h4>
<span class="header-section-number">13.3.1.3</span> Modeling the original unbalanced data<a class="anchor" aria-label="anchor" href="#modeling-the-original-unbalanced-data"><i class="fas fa-link"></i></a>
</h4>
<p>Here is the same model I used in my webinar example: I randomly divide the data into training and test sets (stratified by class) and perform Random Forest modeling with 10 x 10 repeated cross-validation. Final model performance is then measured on the test set.</p>
<div class="sourceCode" id="cb339"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html">createDataPartition</a></span><span class="op">(</span><span class="va">bc_data</span><span class="op">$</span><span class="va">classes</span>, p <span class="op">=</span> <span class="fl">0.7</span>, list <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">bc_data</span><span class="op">[</span><span class="va">index</span>, <span class="op">]</span>
<span class="va">test_data</span>  <span class="op">&lt;-</span> <span class="va">bc_data</span><span class="op">[</span><span class="op">-</span><span class="va">index</span>, <span class="op">]</span></code></pre></div>
<div class="sourceCode" id="cb340"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">model_rf</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">classes</span> <span class="op">~</span> <span class="va">.</span>,
                         data <span class="op">=</span> <span class="va">train_data</span>,
                         method <span class="op">=</span> <span class="st">"rf"</span>,
                         preProcess <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scale"</span>, <span class="st">"center"</span><span class="op">)</span>,
                         trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"repeatedcv"</span>, 
                                                  number <span class="op">=</span> <span class="fl">10</span>, 
                                                  repeats <span class="op">=</span> <span class="fl">10</span>, 
                                                  verboseIter <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb341"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>actual <span class="op">=</span> <span class="va">test_data</span><span class="op">$</span><span class="va">classes</span>,
                    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_rf</span>, 
                            newdata <span class="op">=</span> <span class="va">test_data</span>, 
                            type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span>

<span class="va">final</span><span class="op">$</span><span class="va">predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">final</span><span class="op">$</span><span class="va">benign</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="st">"benign"</span>, <span class="st">"malignant"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb342"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op">(</span><span class="va">final</span><span class="op">$</span><span class="va">predict</span><span class="op">)</span>
<span class="va">test_data_classes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span>

<span class="va">cm_original</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span><span class="va">final_predict</span>, <span class="va">test_data_classes</span><span class="op">)</span>
<span class="va">cm_original</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">'Sensitivity'</span><span class="op">]</span>
<span class="co">#&gt; Sensitivity </span>
<span class="co">#&gt;       0.978</span></code></pre></div>
</div>
</div>
</div>
<div id="under-sampling" class="section level2">
<h2>
<span class="header-section-number">13.4</span> Under-sampling<a class="anchor" aria-label="anchor" href="#under-sampling"><i class="fas fa-link"></i></a>
</h2>
<p>Luckily, <code>caret</code> makes it very easy to incorporate over- and under-sampling techniques with cross-validation resampling. We can simply add the sampling option to our <code>trainControl</code> and choose down for under- (also called <code>down</code>-) sampling. The rest stays the same as with our original model.</p>
<div class="sourceCode" id="cb343"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"repeatedcv"</span>, 
                     number <span class="op">=</span> <span class="fl">10</span>, 
                     repeats <span class="op">=</span> <span class="fl">10</span>, 
                     verboseIter <span class="op">=</span> <span class="cn">FALSE</span>,
                     sampling <span class="op">=</span> <span class="st">"down"</span><span class="op">)</span>


<span class="va">model_rf_under</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">classes</span> <span class="op">~</span> <span class="va">.</span>,
                         data <span class="op">=</span> <span class="va">train_data</span>,
                         method <span class="op">=</span> <span class="st">"rf"</span>,
                         preProcess <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scale"</span>, <span class="st">"center"</span><span class="op">)</span>,
                         trControl <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb344"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_under</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>actual <span class="op">=</span> <span class="va">test_data</span><span class="op">$</span><span class="va">classes</span>,
                    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_rf_under</span>, 
                            newdata <span class="op">=</span> <span class="va">test_data</span>, 
                            type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span>

<span class="va">final_under</span><span class="op">$</span><span class="va">predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">final_under</span><span class="op">$</span><span class="va">benign</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="st">"benign"</span>, <span class="st">"malignant"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb345"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_under_predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op">(</span><span class="va">final_under</span><span class="op">$</span><span class="va">predict</span><span class="op">)</span>
<span class="va">test_data_classes</span> <span class="op">&lt;-</span> <span class="va">test_data</span><span class="op">$</span><span class="va">classes</span>

<span class="va">cm_under</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span><span class="va">final_under_predict</span>, <span class="va">test_data_classes</span><span class="op">)</span>
<span class="va">cm_under</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">'Sensitivity'</span><span class="op">]</span>
<span class="co">#&gt; Sensitivity </span>
<span class="co">#&gt;       0.978</span></code></pre></div>
</div>
<div id="oversampling" class="section level2">
<h2>
<span class="header-section-number">13.5</span> Oversampling<a class="anchor" aria-label="anchor" href="#oversampling"><i class="fas fa-link"></i></a>
</h2>
<p>For over- (also called up-) sampling we simply specify sampling = “up”.</p>
<div class="sourceCode" id="cb346"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"repeatedcv"</span>, 
                     number <span class="op">=</span> <span class="fl">10</span>, 
                     repeats <span class="op">=</span> <span class="fl">10</span>, 
                     verboseIter <span class="op">=</span> <span class="cn">FALSE</span>,
                     sampling <span class="op">=</span> <span class="st">"up"</span><span class="op">)</span>


<span class="va">model_rf_over</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">classes</span> <span class="op">~</span> <span class="va">.</span>,
                         data <span class="op">=</span> <span class="va">train_data</span>,
                         method <span class="op">=</span> <span class="st">"rf"</span>,
                         preProcess <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scale"</span>, <span class="st">"center"</span><span class="op">)</span>,
                         trControl <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb347"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_over</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>actual <span class="op">=</span> <span class="va">test_data</span><span class="op">$</span><span class="va">classes</span>,
                          <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_rf_over</span>, 
                                  newdata <span class="op">=</span> <span class="va">test_data</span>, 
                                  type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span>

<span class="va">final_over</span><span class="op">$</span><span class="va">predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">final_over</span><span class="op">$</span><span class="va">benign</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="st">"benign"</span>, <span class="st">"malignant"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb348"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_over_predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op">(</span><span class="va">final_over</span><span class="op">$</span><span class="va">predict</span><span class="op">)</span>
<span class="va">test_data_classes</span> <span class="op">&lt;-</span> <span class="va">test_data</span><span class="op">$</span><span class="va">classes</span>

<span class="va">cm_over</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span><span class="va">final_over_predict</span>, <span class="va">test_data_classes</span><span class="op">)</span>
<span class="va">cm_over</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">'Sensitivity'</span><span class="op">]</span>
<span class="co">#&gt; Sensitivity </span>
<span class="co">#&gt;       0.978</span></code></pre></div>
<div id="rose" class="section level3">
<h3>
<span class="header-section-number">13.5.1</span> ROSE<a class="anchor" aria-label="anchor" href="#rose"><i class="fas fa-link"></i></a>
</h3>
<p>Besides over- and under-sampling, there are hybrid methods that combine under-sampling with the generation of additional data. Two of the most popular are ROSE and SMOTE.</p>
<blockquote>
<p>From Nicola Lunardon, Giovanna Menardi and Nicola Torelli’s “ROSE: A Package for Binary Imbalanced Learning” (R Journal, 2014, Vol. 6 Issue 1, p. 79): “The ROSE package provides functions to deal with binary classification problems in the presence of imbalanced classes. Artificial balanced samples are generated according to a smoothed bootstrap approach and allow for aiding both the phases of estimation and accuracy evaluation of a binary classifier in the presence of a rare class. Functions that implement more traditional remedies for the class imbalance and different metrics to evaluate accuracy are also provided. These are estimated by holdout, bootstrap, or cross-validation methods.”</p>
</blockquote>
<p>You implement them the same way as before, this time choosing sampling = “rose”…</p>
<div class="sourceCode" id="cb349"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"repeatedcv"</span>, 
                     number <span class="op">=</span> <span class="fl">10</span>, 
                     repeats <span class="op">=</span> <span class="fl">10</span>, 
                     verboseIter <span class="op">=</span> <span class="cn">FALSE</span>,
                     sampling <span class="op">=</span> <span class="st">"rose"</span><span class="op">)</span>

<span class="va">model_rf_rose</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">classes</span> <span class="op">~</span> <span class="va">.</span>,
                              data <span class="op">=</span> <span class="va">train_data</span>,
                              method <span class="op">=</span> <span class="st">"rf"</span>,
                              preProcess <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scale"</span>, <span class="st">"center"</span><span class="op">)</span>,
                              trControl <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span>
<span class="co">#&gt; Loaded ROSE 0.0-3</span></code></pre></div>
<div class="sourceCode" id="cb350"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_rose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>actual <span class="op">=</span> <span class="va">test_data</span><span class="op">$</span><span class="va">classes</span>,
                         <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_rf_rose</span>, 
                                 newdata <span class="op">=</span> <span class="va">test_data</span>, 
                                 type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span>

<span class="va">final_rose</span><span class="op">$</span><span class="va">predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">final_rose</span><span class="op">$</span><span class="va">benign</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="st">"benign"</span>, <span class="st">"malignant"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb351"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cm_rose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op">(</span><span class="va">final_rose</span><span class="op">$</span><span class="va">predict</span><span class="op">)</span>, 
                           <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span><span class="op">)</span>
<span class="va">cm_rose</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">'Sensitivity'</span><span class="op">]</span>
<span class="co">#&gt; Sensitivity </span>
<span class="co">#&gt;       0.985</span></code></pre></div>
</div>
<div id="smote" class="section level3">
<h3>
<span class="header-section-number">13.5.2</span> SMOTE<a class="anchor" aria-label="anchor" href="#smote"><i class="fas fa-link"></i></a>
</h3>
<p>… or by choosing sampling = “smote” in the <code>trainControl</code> settings.</p>
<blockquote>
<p>From Nitesh V. Chawla, Kevin W. Bowyer, Lawrence O. Hall and W. Philip Kegelmeyer’s “SMOTE: Synthetic Minority Over-sampling Technique” (Journal of Artificial Intelligence Research, 2002, Vol. 16, pp. 321–357): “This paper shows that a combination of our method of over-sampling the minority (abnormal) class and under-sampling the majority (normal) class can achieve better classifier performance (in ROC space) than only under-sampling the majority class. This paper also shows that a combination of our method of over-sampling the minority class and under-sampling the majority class can achieve better classifier performance (in ROC space) than varying the loss ratios in Ripper or class priors in Naive Bayes. Our method of over-sampling the minority class involves creating synthetic minority class examples.”</p>
</blockquote>
<div class="sourceCode" id="cb352"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"repeatedcv"</span>, 
                     number <span class="op">=</span> <span class="fl">10</span>, 
                     repeats <span class="op">=</span> <span class="fl">10</span>, 
                     verboseIter <span class="op">=</span> <span class="cn">FALSE</span>,
                     sampling <span class="op">=</span> <span class="st">"smote"</span><span class="op">)</span>

<span class="va">model_rf_smote</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">classes</span> <span class="op">~</span> <span class="va">.</span>,
                              data <span class="op">=</span> <span class="va">train_data</span>,
                              method <span class="op">=</span> <span class="st">"rf"</span>,
                              preProcess <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scale"</span>, <span class="st">"center"</span><span class="op">)</span>,
                              trControl <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: grid</span>
<span class="co">#&gt; Registered S3 method overwritten by 'quantmod':</span>
<span class="co">#&gt;   method            from</span>
<span class="co">#&gt;   as.zoo.data.frame zoo</span></code></pre></div>
<div class="sourceCode" id="cb353"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">final_smote</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>actual <span class="op">=</span> <span class="va">test_data</span><span class="op">$</span><span class="va">classes</span>,
                         <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_rf_smote</span>, 
                                 newdata <span class="op">=</span> <span class="va">test_data</span>, 
                                 type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span>

<span class="va">final_smote</span><span class="op">$</span><span class="va">predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">final_smote</span><span class="op">$</span><span class="va">benign</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="st">"benign"</span>, <span class="st">"malignant"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb354"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cm_smote</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op">(</span><span class="va">final_smote</span><span class="op">$</span><span class="va">predict</span><span class="op">)</span>, 
                            <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span><span class="op">)</span>
<span class="va">cm_smote</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">'Sensitivity'</span><span class="op">]</span>
<span class="co">#&gt; Sensitivity </span>
<span class="co">#&gt;       0.978</span></code></pre></div>
</div>
</div>
<div id="predictions" class="section level2">
<h2>
<span class="header-section-number">13.6</span> Predictions<a class="anchor" aria-label="anchor" href="#predictions"><i class="fas fa-link"></i></a>
</h2>
<p>Now let’s compare the predictions of all these models:</p>
<div class="sourceCode" id="cb355"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
                original <span class="op">=</span> <span class="va">model_rf</span>,
                under <span class="op">=</span> <span class="va">model_rf_under</span>,
                over <span class="op">=</span> <span class="va">model_rf_over</span>,
                smote <span class="op">=</span> <span class="va">model_rf_smote</span>,
                rose <span class="op">=</span> <span class="va">model_rf_rose</span><span class="op">)</span>

<span class="va">resampling</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/resamples.html">resamples</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mice/man/bwplot.mids.html">bwplot</a></span><span class="op">(</span><span class="va">resampling</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="105-fe-meta_131-unbalanced_data-sglander_files/figure-html/plot-resampling-1.png" width="70%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb356"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,
                         Sensitivity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span>,
                         Specificity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span>,
                         Precision   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span>,
                         Recall      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span>,
                         F1          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">cm_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"cm_"</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span>
    <span class="va">comparison</span><span class="op">[</span><span class="va">comparison</span><span class="op">$</span><span class="va">model</span><span class="op">==</span><span class="va">name</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">comparison</span>, <span class="va">model</span><span class="op">==</span><span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Sensitivity <span class="op">=</span> <span class="va">cm_model</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">"Sensitivity"</span><span class="op">]</span>,
           Specificity <span class="op">=</span> <span class="va">cm_model</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">"Specificity"</span><span class="op">]</span>,
           Precision   <span class="op">=</span> <span class="va">cm_model</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">"Precision"</span><span class="op">]</span>,
           Recall      <span class="op">=</span> <span class="va">cm_model</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">"Recall"</span><span class="op">]</span>,
           F1          <span class="op">=</span> <span class="va">cm_model</span><span class="op">$</span><span class="va">byClass</span><span class="op">[</span><span class="st">"F1"</span><span class="op">]</span>
  <span class="op">)</span>
<span class="op">}</span>    

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">comparison</span><span class="op">)</span>
<span class="co">#&gt;      model Sensitivity Specificity Precision Recall    F1</span>
<span class="co">#&gt; 1 original       0.978       0.986     0.993  0.978 0.985</span>
<span class="co">#&gt; 2    under       0.978       1.000     1.000  0.978 0.989</span>
<span class="co">#&gt; 3     over       0.978       0.986     0.993  0.978 0.985</span>
<span class="co">#&gt; 4    smote       0.978       0.986     0.993  0.978 0.985</span>
<span class="co">#&gt; 5     rose       0.985       0.986     0.993  0.985 0.989</span></code></pre></div>
<div class="sourceCode" id="cb357"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="va">comparison</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">Sensitivity</span><span class="op">:</span><span class="va">F1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="105-fe-meta_131-unbalanced_data-sglander_files/figure-html/comparison-plot-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>With this small dataset, we can already see how the different techniques can influence model performance. <strong>Sensitivity</strong> (or <strong>recall</strong>) describes the proportion of benign cases that have been predicted correctly, while <strong>specificity</strong> describes the proportion of malignant cases that have been predicted correctly. <strong>Precision describes</strong> the true positives, i.e. the proportion of benign predictions that were actual from benign samples. <strong>F1</strong> is the weighted average of precision and sensitivity/ recall.</p>
</div>
<div id="final-notes" class="section level2">
<h2>
<span class="header-section-number">13.7</span> Final notes<a class="anchor" aria-label="anchor" href="#final-notes"><i class="fas fa-link"></i></a>
</h2>
<p>Here, all four methods improved specificity and precision compared to the original model. Under-sampling, over-sampling and ROSE additionally improved precision and the F1 score.</p>
<p>This post shows a simple example of how to correct for unbalance in datasets for machine learning. For more advanced instructions and potential caveats with these techniques, check out the excellent <code>caret</code> documentation.</p>
<p>If you are interested in more machine learning posts, check out the category listing for machine_learning on my blog.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="feature-selection-to-enhance-cancer-detection.html"><span class="header-section-number">12</span> Feature Selection to enhance cancer detection</a></div>
<div class="next"><a href="imputting-missing-values-with-random-forest.html"><span class="header-section-number">14</span> Imputting missing values with Random Forest</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#dealing-with-unbalanced-data"><span class="header-section-number">13</span> Dealing with unbalanced data</a></li>
<li><a class="nav-link" href="#breast-cancer-dataset"><span class="header-section-number">13.1</span> Breast cancer dataset</a></li>
<li><a class="nav-link" href="#introduction-6"><span class="header-section-number">13.2</span> Introduction</a></li>
<li>
<a class="nav-link" href="#read-and-process-the-data-1"><span class="header-section-number">13.3</span> Read and process the data</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#unbalanced-data"><span class="header-section-number">13.3.1</span> Unbalanced data</a></li></ul>
</li>
<li><a class="nav-link" href="#under-sampling"><span class="header-section-number">13.4</span> Under-sampling</a></li>
<li>
<a class="nav-link" href="#oversampling"><span class="header-section-number">13.5</span> Oversampling</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#rose"><span class="header-section-number">13.5.1</span> ROSE</a></li>
<li><a class="nav-link" href="#smote"><span class="header-section-number">13.5.2</span> SMOTE</a></li>
</ul>
</li>
<li><a class="nav-link" href="#predictions"><span class="header-section-number">13.6</span> Predictions</a></li>
<li><a class="nav-link" href="#final-notes"><span class="header-section-number">13.7</span> Final notes</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/f0nzie/machine_learning_compilation/blob/master/105-fe-meta_131-unbalanced_data-sglander.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/f0nzie/machine_learning_compilation/edit/master/105-fe-meta_131-unbalanced_data-sglander.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>A Machine Learning Compilation</strong>" was written by Several authors. Compiled by Alfonso R. Reyes. It was last built on 2020-11-19.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
